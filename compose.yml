
services:
  nginx:
    image: amazingplum/nginx:latest
    build: 
      context: https://github.com/amazingplum53/docker_compose.git#master:docker
      dockerfile: nginx.dockerfile
    hostname: matthewhill.click
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - encrypt:/letsencrypt
      - challenge:/var/www/certbot
      - static:/static
    depends_on:
      - certbot
    entrypoint: ["bash", "-c"]
    command: ["nginx -c /etc/nginx/nginx.conf -g 'daemon off;' & /var/controller.sh"]

  certbot:
    image: amazingplum/certbot:latest
    build: 
      context: https://github.com/amazingplum53/docker_compose.git#master:docker
      dockerfile: certbot.dockerfile
    volumes:
      - encrypt:/etc/letsencrypt
      - challenge:/var/www/certbot  
    entrypoint: ["/bin/bash"]
    command: ["/var/renew.sh"]

  gunicorn:
    image: amazingplum/gunicorn:latest
    build:
      context: https://github.com/amazingplum53/docker_compose.git#master:docker
      dockerfile: gunicorn.dockerfile
    expose:
      - 8000
    entrypoint: ["gunicorn"]
    command: ["wsgi:app", "--chdir", "/var/www/", "-c", "gunicorn.config.py"]

volumes:
  challenge:
  encrypt:
  static: 

